<!DOCTYPE html>
<html lang="en"><body>

<script>
var m_w = 123456789; var m_z = 987654321; var mask = 0xffffffff;
m_w = new Date().getTime();
function randomDouble () {
	m_z = (36969 * (m_z & 65535) + (m_z >> 16)) & mask;
	m_w = (18000 * (m_w & 65535) + (m_w >> 16)) & mask;
	var result = ((m_z << 16) + m_w) & mask;
	result /= 4294967296;
	return result + 0.5;
}
function randomBetween (start,end) { return start + randomDouble() * (end-start); }

var canvas = document.createElement("canvas");
canvas.setAttribute('style', 'border: 1px solid');
var context = canvas.getContext("2d");
canvas.width = 640;
canvas.height = 480;
document.body.appendChild(canvas);
var keysDown = {};
addEventListener("keydown", function (e) { keysDown[e.keyCode] = true; }, false);
addEventListener("keyup", function (e) { delete keysDown[e.keyCode]; }, false);

var player = {x:200,y:200,gotoX:200,gotoY:200};
var enemies = [{x:100,y:100,gotoX:100,gotoY:200},{x:400,y:300,gotoX:400,gotoY:350}];
var walls = [{x1:20,y1:20,x2:20,y2:400},{x1:20,y1:20,x2:600,y2:20},
		{x1:600,y1:20,x2:600,y2:400},{x1:20,y1:400,x2:600,y2:400},
		{x1:250,y1:100,x2:225,y2:300},{x1:500,y1:300,x2:225,y2:290},
		{x1:270,y1:120,x2:240,y2:340},{x1:530,y1:330,x2:245,y2:300}];
function update () { 
	if (38 in keysDown) player.gotoY = player.y - 4;
	if (40 in keysDown) player.gotoY = player.y + 4;
	if (37 in keysDown) player.gotoX = player.x - 4;
	if (39 in keysDown) player.gotoX = player.x + 4;
	if (noWallCollisions(player.x,player.y,player.gotoX,player.gotoY)) {player.x = player.gotoX; player.y = player.gotoY;}
	player.gotoX = player.x;player.gotoY = player.y;
	for ( var i = 0; i < enemies.length; i++ ) {
		var journeyLength = lengthOfLine(enemies[i].x,enemies[i].y,enemies[i].gotoX,enemies[i].gotoY);
		var enemySpeed = 2;
		if ( journeyLength > enemySpeed ) {
			// go partway to the destination
			var partOfLine = enemySpeed/journeyLength;
			enemies[i].x += (enemies[i].gotoX - enemies[i].x) * partOfLine;
			enemies[i].y += (enemies[i].gotoY - enemies[i].y) * partOfLine;
		} else {
			// find a new destination
			var newX = randomBetween(0,640);
			var newY = randomBetween(0,480);
			while(true) {
				// Keep trying new places until we find one we can get to.
				if (noWallCollisions(enemies[i].x,enemies[i].y,newX,newY)) break;
				else {
					var newX = randomBetween(0,640);
					var newY = randomBetween(0,480);
				}
			}
			enemies[i].gotoX = newX; enemies[i].gotoY = newY;
		}
	}
}
function render () { 
	clear(); 
	for ( var i = 0; i < walls.length; i++ ) {
		drawLine(walls[i].x1, walls[i].y1, walls[i].x2, walls[i].y2)
	}
	drawBox(player.x-10, player.y-10, 20,20, "blue");
	for ( var i = 0; i < enemies.length; i++ ) {
		color = colorForLineOfSight(enemies[i]);
		drawBox(enemies[i].x-10, enemies[i].y-10, 20,20, color);
		drawLine(enemies[i].x, enemies[i].y, player.x, player.y);
	}
}

function colorForLineOfSight(enemy) {
	var color = "black";
	if (noWallCollisions(enemy.x,enemy.y,player.x,player.y)) {
		color = "red";
	} else {
		color = "orange";
	}
	return color;
}

function noWallCollisions(x1,y1,x2,y2) {
	for ( var j = 0; j < walls.length; j++ ) { 
		if ( checkLineIntersection(x1,y1,x2,y2, walls[j].x1,walls[j].y1,walls[j].x2,walls[j].y2) ) return false; 
	}
	return true;
}

function clear () { canvas.width = canvas.width; };
function drawBox (x,y,w,h,color) { context.fillStyle = color; context.fillRect(x,y,w,h); }
function checkLineIntersection(line1StartX, line1StartY, line1EndX, line1EndY, line2StartX, line2StartY, line2EndX, line2EndY) {
    var denominator, a, b, numerator1, numerator2, result = { x: null, y: null, onLine1: false, onLine2: false };
    denominator = ((line2EndY - line2StartY) * (line1EndX - line1StartX)) - ((line2EndX - line2StartX) * (line1EndY - line1StartY));
    if (denominator == 0) return false;
    a = line1StartY - line2StartY;
    b = line1StartX - line2StartX;
    numerator1 = ((line2EndX - line2StartX) * a) - ((line2EndY - line2StartY) * b);
    numerator2 = ((line1EndX - line1StartX) * a) - ((line1EndY - line1StartY) * b);
    a = numerator1 / denominator;
    b = numerator2 / denominator;
    if (a >= 0 && a <= 1) result.onLine1 = true;
    if (b >= 0 && b <= 1) result.onLine2 = true;
    return result.onLine1 && result.onLine2;
}
function lengthOfLine(x1, y1, x2, y2) {
	var a2 = Math.pow((x1-x2),2);
	var b2 = Math.pow((y1-y2),2);
	return Math.sqrt(a2+b2);
}
function drawLine(x1,y1,x2,y2) { 
	context.moveTo(x1,y1); context.lineTo(x2,y2); context.stroke(); 
}
setInterval(function () { update(); render(); }, 20);
</script>

</body></html>
