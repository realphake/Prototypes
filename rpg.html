<!DOCTYPE html> <html lang="en"> <body>
<script src="genericFunctions.js"></script> <script>

///////////////////////
// Global Variables! //
///////////////////////
var programState, turnNumber;
var worldMap, seenMap, smellMap;
var playerLocation, npcs;
var framesElapsed;
var gridSize;
var gameSpeed;
var GRASS = 0, WATER = 1, ROCK = 2, SAND = 3;

////////////////////////
// Utility functions! //
////////////////////////

function lineOfSight (start, end) {
	var line = bresenhamLine(start, end);
	for ( var p = 1; p < line.length-1; p ++ ) {
		if ( ! tileVisible(line[p].x,line[p].y) ) { return false; }
	}
	return true;
}

function lineOfEffect (start, end) {
	var line = bresenhamLine(start, end);
	for ( var p = 1; p < line.length-1; p ++ ) {
		if ( ! tileWalkable(line[p].x,line[p].y) ) { return false; }
	}
	return true;
}

function directionToCoords(direction) {
	var dX = Math.round(Math.cos( direction/4 * 2 * Math.PI ));
	var dY = -Math.round(Math.sin( direction/4 * 2 * Math.PI ));
	return {x:dX,y:dY};
}

function npcAt (x,y) {
	for ( var c = 0; c < npcs.length; c++ ) {
		if (npcs[c].x+npcs[c].moveX == x && npcs[c].y+npcs[c].moveY == y) {
			return c;
		}
	}
}

function tileWalkable(x,y) {
	if (worldMap[y][x] == undefined) { return false; }
	if (worldMap[y][x] == ROCK || worldMap[y][x] == WATER) { return false; }
	if (player.x+player.moveX == x && player.y+player.moveY == y) { return false; }
	if ( npcAt (x,y) ) { return false; }
	for ( var c = 0; c < npcs.length; c++ ) {
		if (npcs[c].x+npcs[c].moveX == x && npcs[c].y+npcs[c].moveY == y) {
			return false;
		}
	}
	return true;
}

function tileVisible(x,y) {
	var visibleTerrain = true;
	if (worldMap[y][x] == undefined) { visibleTerrain = false; }
	if (worldMap[y][x] == ROCK) { visibleTerrain = false; }
	return visibleTerrain;
}

function tileColorByType ( tileType ) {
	if ( tileType == GRASS ) return "green";
	if ( tileType == WATER ) return "blue";
	if ( tileType == ROCK ) return "red";
	if ( tileType == SAND ) return "yellow";
}

function planPlayerMoves () {
	player.moveX = 0; player.moveY = 0;
	if (keyIsDown ('up') && tileWalkable(player.x,player.y-1)) { player.moveY -= 1; }
	else if (keyIsDown ('down') && tileWalkable(player.x,player.y+1)) { player.moveY += 1; }
	else if (keyIsDown ('left') && tileWalkable(player.x-1,player.y)) { player.moveX -= 1; }
	else if (keyIsDown ('right') && tileWalkable(player.x+1,player.y)) { player.moveX += 1; }
}

function chasePlayer (c) {
	var highestSmell = 0;
	var move = {x:0,y:0};
	if (highestSmell < smellMap[npcs[c].y+1][npcs[c].x] && tileWalkable(npcs[c].x,npcs[c].y+1)) {
		highestSmell = smellMap[npcs[c].y+1][npcs[c].x];
		move = {x:0,y:1};
	}
	if (highestSmell < smellMap[npcs[c].y-1][npcs[c].x] && tileWalkable(npcs[c].x,npcs[c].y-1)) {
		highestSmell = smellMap[npcs[c].y-1][npcs[c].x];
		move = {x:0,y:-1};
	}
	if (highestSmell < smellMap[npcs[c].y][npcs[c].x+1] && tileWalkable(npcs[c].x+1,npcs[c].y)) {
		highestSmell = smellMap[npcs[c].y][npcs[c].x+1];
		move = {x:1,y:0};
	} 
	if (highestSmell < smellMap[npcs[c].y][npcs[c].x-1] && tileWalkable(npcs[c].x-1,npcs[c].y) ) {
		highestSmell = smellMap[npcs[c].y][npcs[c].x-1];
		move = {x:-1,y:0};
	}
	return move
}

function planNpcMoves () {
	for ( var c = 0; c < npcs.length; c++ ) {
		var move = {x:0,y:0};
		if (npcs[c].hostile) {
			move = chasePlayer(c);
		}
		if ( tileWalkable(npcs[c].x+move.x, npcs[c].y+move.y) ) {
			npcs[c].moveX = move.x;
			npcs[c].moveY = move.y;
		}
	}
}

function executePlayerMove () {
	player.x += player.moveX; 
	player.moveX = 0;
	player.y += player.moveY; 
	player.moveY = 0;
}

function executeNpcMoves () {
	for ( var c = 0; c < npcs.length; c++ ) {
		npcs[c].x += npcs[c].moveX; 
		npcs[c].moveX = 0;
		npcs[c].y += npcs[c].moveY; 
		npcs[c].moveY = 0;
	}
}

function updateSeenMap () {
	for (var x = 0; x < worldMap[0].length; x ++ ) {
		for (var y = 0; y < worldMap.length; y ++ ) {
			if ( lineOfSight (player,{x:x,y:y}) ) { seenMap[y][x] = 1; }
		}
	}
}

function updateSmellMap () {
	for (var x = 0; x < worldMap[0].length; x ++ ) {
		for (var y = 0; y < worldMap.length; y ++ ) {
			if ( lineOfEffect (player,{x:x,y:y}) ) { 
				smellMap[y][x] = 20*turnNumber - manhattanDistance(player,{x:x,y:y}); 
			}
		}
	}
}

function formallyExecuteMoves () {
	turnNumber+=1;
	executePlayerMove ();
	executeNpcMoves ();
	updateSeenMap ();
	updateSmellMap ();
}

function drawCharacter (character) {
	fillCircle( character.x*gridSize+gridSize/2+character.moveX*framesElapsed,
				character.y*gridSize+gridSize/2+character.moveY*framesElapsed,
				gridSize/2,character.color);
}

function drawFogOfWar() {
	holdChanges();
	for ( var y = 0; y < worldMap.length; y++) {
		for ( var x = 0; x < worldMap[y].length; x++) {
			if ( ! lineOfSight (player,{x:x,y:y}) ) { 
				fillBox (x*gridSize,y*gridSize,gridSize,gridSize,"black"); 
			}
		}
	}
	deployChanges('source-over', 0.5);
}

function drawTerrain () {
	for ( var y = 0; y < worldMap.length; y++) {
		for ( var x = 0; x < worldMap[y].length; x++) {
			drawTile(x,y);
		}
	}
}

function drawTile(x,y) {
	var tileColor = tileColorByType ( worldMap[y][x] );
	if ( seenMap[y][x] == 0 )  {
		tileColor = "black";
	}
	fillBox (x*gridSize,y*gridSize,gridSize,gridSize,tileColor);
}

///////////////////////////////////
// Important backbone functions! //
///////////////////////////////////

function updateGame() {
	if (framesElapsed >= gridSize) {
		planPlayerMoves ();
		if (player.moveX != 0 || player.moveY != 0) {
			planNpcMoves ();
			framesElapsed = 0;
		}
	}
	else if ( framesElapsed < gridSize ) {
		framesElapsed += gameSpeed;
		if ( framesElapsed >= gridSize ) { formallyExecuteMoves(); }
	}
}

function renderGame() {
	drawTerrain ();
	drawCharacter (player);
	for ( var c = 0; c < npcs.length; c++ ) { 
		if ( lineOfSight (player,npcs[c]) ) drawCharacter (npcs[c]) ;
	}
	drawFogOfWar();
}

function updateMainMenu() {
	if ( keyIsDown ("right") ) { programState = 1; }
}

function renderMainMenu() {
	writeText("Game menu!",100,100, "black");
	writeText("Press right to start.",100,130, "black");
}

///////////////////////////
// Background functions! //
///////////////////////////

function setup () {
	programState = 0;
	turnNumber = 0;
	player = {x:1,y:1,moveX:0,moveY:0,color:"black"};
	npcs = [{x:2,y:2,moveX:0,moveY:0,hostile:false,color:"white"},
			{x:1,y:2,moveX:0,moveY:0,hostile:false,color:"white"},
			{x:20,y:20,moveX:0,moveY:0,hostile:true,color:"white"}];
	gridSize = 16;
	framesElapsed = 0;
	gameSpeed = 3;
	worldMap = [
		[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0],
		[2,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,2,2,2,2,2,2,2,2,2,2,2,2],
		[0,0,0,0,0,3,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,2,0,0,0,0,0,2],
		[0,0,0,0,0,3,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,2,0,0,0,0,0,2],
		[0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,2,0,0,0,0,0,2],
		[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,2,2,2,2,0,2,0,2,2,2,2,2],
		[0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,2],
		[0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,2,0,2,2,2,2,2,2,2,2,2,0,2],
		[0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		[2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		[2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		[2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		[2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		[2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		[2,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		[2,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		[2,2,2,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		[2,2,2,2,2,2,2,0,0,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,0,0,0,0,0,0,0,0],
		[2,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		[2,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		[2,2,2,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		[2,2,2,2,2,2,2,0,0,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,0,0,0,0,0,0,0,0],
		[2,2,2,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		[2,2,2,2,2,2,2,0,0,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,0,0,0,0,0,0,0,0]];
	seenMap = twoDimensionalZeroes(worldMap.length, worldMap[0].length);
	smellMap = twoDimensionalZeroes(worldMap.length, worldMap[0].length);
}

function update () { 
	if ( programState == 0 ) { updateMainMenu(); }
	else if ( programState == 1 ) { updateGame(); }
}

function render () { 
	clear();
	if ( programState == 0 ) { renderMainMenu(); }
	else if ( programState == 1 ) { renderGame(); }
}

/////////////////////
// Start the game. //
/////////////////////

setup ();
setInterval (function () {update () ; render () ;} , 20) ;

</script></body></html>
