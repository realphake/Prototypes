<!DOCTYPE html> <html lang="en"> <body>
<script src="genericFunctions.js"></script> <script>

///////////////////////
// Global Variables! //
///////////////////////
var programState;
var worldMap;
var playerLocation;
var framesElapsed;
var gridSize;
var gameSpeed;
var npcs;
var GRASS = 0, WATER = 1, ROCK = 2;
var EAST = 0, NORTH = 1, WEST = 2, SOUTH = 3;

////////////////////////
// Utility functions! //
////////////////////////

function directionToCoords(direction) {
	dX = Math.round(Math.cos( direction/4 * 2 * Math.PI ));
	dY = -Math.round(Math.sin( direction/4 * 2 * Math.PI ));
	return {x:dX,y:dY};
}

function tileWalkable(x,y) {
	walkableTerrain = true;
	if (worldMap[y][x] == undefined) {
		walkableTerrain = false;
	}
	if (worldMap[y][x] == ROCK || worldMap[y][x] == WATER) {
		walkableTerrain = false;
	}
	if (player.x+player.moveX == x && player.y+player.moveY == y) {
		walkableTerrain = false;
	}
	for ( var c = 0; c < npcs.length; c++ ) {
		if (npcs[c].x+npcs[c].moveX == x && npcs[c].y+npcs[c].moveY == y) {
			walkableTerrain = false;
		}
	}
	return walkableTerrain;
}

function tileColorByType ( tileType ) {
	if ( tileType == GRASS ) return "green";
	if ( tileType == WATER ) return "blue";
	if ( tileType == ROCK ) return "red";
}

function planPlayerMoves () {
	player.moveX = 0; player.moveY = 0;
	if (keyIsDown ('up') && tileWalkable(player.x,player.y-1)) 
		player.moveY -= 1;
	else if (keyIsDown ('down') && tileWalkable(player.x,player.y+1)) 
		player.moveY += 1;
	else if (keyIsDown ('left') && tileWalkable(player.x-1,player.y)) 
		player.moveX -= 1;
	else if (keyIsDown ('right') && tileWalkable(player.x+1,player.y)) 
		player.moveX += 1;
}

function planNpcMoves () {
	for ( var c = 0; c < npcs.length; c++ ) {
		move = directionToCoords(randInt (0,4));
		if ( tileWalkable(npcs[c].x+move.x, npcs[c].y+move.y) ) {
			npcs[c].moveX = move.x;
			npcs[c].moveY = move.y;
		}
	}
}

function formallyExecuteMoves () {
	player.x += player.moveX; 
	player.moveX = 0;
	player.y += player.moveY; 
	player.moveY = 0;
	for ( var c = 0; c < npcs.length; c++ ) {
		npcs[c].x += npcs[c].moveX; 
		npcs[c].moveX = 0;
		npcs[c].y += npcs[c].moveY; 
		npcs[c].moveY = 0;
	}
}

function drawCharacter (character) {
	fillCircle(character.x*20+10+character.moveX*framesElapsed,
			   character.y*20+10+character.moveY*framesElapsed,
			   10,character.color);
}

///////////////////////////////////
// Important backbone functions! //
///////////////////////////////////

function updateGame() {
	if (framesElapsed >= gridSize) {
		planPlayerMoves ();
		if (player.moveX != 0 || player.moveY != 0) {
			planNpcMoves ();
			framesElapsed = 0;
		}
	}
	else if ( framesElapsed < gridSize ) {
		framesElapsed += gameSpeed;
		if ( framesElapsed >= gridSize )
			formallyExecuteMoves();
	}
}

function renderGame() {
	for ( var x = 0; x < 640/gridSize; x++) {
		for ( var y = 0; y < 480/gridSize; y++) {
			var tileColor = tileColorByType ( worldMap[y][x] );
			fillBox (x*gridSize,y*gridSize,gridSize,gridSize,tileColor);
		}
	}
	drawCharacter (player);
	for ( var c = 0; c < npcs.length; c++ ) {
		drawCharacter (npcs[c]) ;
	}
}

function updateMainMenu() {
	if ( keyIsDown ("right") ) programState = 1;
}

function renderMainMenu() {
	writeText("Game menu!",10,10, "black");
	writeText("Press right to start.",10,30, "black");
}

///////////////////////////
// Background functions! //
///////////////////////////

function setup () {
	programState = 0;
	player = {x:1,y:1,moveX:0,moveY:0,color:"black"};
	npcs = [{x:2,y:2,moveX:0,moveY:0,hostile:false,color:"white"},
			{x:1,y:2,moveX:0,moveY:0,hostile:false,color:"white"},
			{x:20,y:20,moveX:0,moveY:0,hostile:true,color:"white"}];
	gridSize = 20;
	framesElapsed = 0;
	gameSpeed = 3;
	worldMap = [
		[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
		[2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		[0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0],
		[0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,2,0,0,0,0,0,0,0,0,0],
		[2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,2,0,0,0,0,0,0,0,0,0],
		[2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		[2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		[2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0],
		[2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0],
		[2,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		[2,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		[2,2,2,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		[2,2,2,2,2,2,2,0,0,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2]];
}

function update () { 
	if ( programState == 0 ) updateMainMenu();
	else if ( programState == 1 ) updateGame();
}

function render () { 
	clear();
	if ( programState == 0 ) renderMainMenu();
	else if ( programState == 1 ) renderGame();
}

/////////////////////
// Start the game. //
/////////////////////

setup ();
setInterval (function () {update () ; render () ;} , 20) ;

</script></body></html>
